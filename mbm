#!/usr/bin/env bash
set -e

APP_DIR="/opt/marzban-backup"
CONF="$APP_DIR/config.conf"
CRON_TAG="# mbm-backup"

install_deps(){
apt-get update -y >/dev/null 2>&1 || true
apt-get install -y curl python3 python3-pip cron >/dev/null 2>&1 || true
systemctl enable --now cron >/dev/null 2>&1 || true
python3 -m pip install -q jdatetime >/dev/null 2>&1 || true
}

save_conf(){
mkdir -p "$APP_DIR"
cat > "$CONF" <<CFG
TOKEN="$TOKEN"
CHAT_ID="$CHAT_ID"
PROXY="$PROXY"
INTERVAL_MINUTES="$INTERVAL_MINUTES"
CFG
chmod 600 "$CONF"
}

load_conf(){
source "$CONF"
}

cron_expr_from_minutes(){
# input: total minutes (>=1), output: cron schedule "m h dom mon dow"
M="$1"
if ! [[ "$M" =~ ^[0-9]+$ ]] || [ "$M" -lt 1 ]; then
  echo ""
  return
fi

if [ "$M" -lt 60 ]; then
  echo "*/$M * * * *"
  return
fi

H=$(( M / 60 ))
R=$(( M % 60 ))

# cap hours step to 23 to avoid cron weirdness
# if H > 23, keep it daily-ish: run every H hours still ok in many cron impl, but safe fallback:
# We'll keep it as */H (cron accepts >23 in hour field? some do, but better keep within 1..23)
# If very large, convert to daily run at 00:00
if [ "$H" -ge 24 ] && [ "$R" -eq 0 ]; then
  echo "0 0 */$((H/24)) * *"
  return
fi

if [ "$H" -ge 24 ] && [ "$R" -ne 0 ]; then
  # fallback: run daily at 00:00 plus minute step R
  # (still no error)
  echo "*/$R 0 */$((H/24)) * *"
  return
fi

if [ "$R" -eq 0 ]; then
  echo "0 */$H * * *"
else
  # Note: cron can't express "every 90 minutes" perfectly; this is an approximation but never errors.
  echo "*/$R */$H * * *"
fi
}

setup_cron(){
expr="$(cron_expr_from_minutes "$INTERVAL_MINUTES")"
[ -n "$expr" ] || { echo "Invalid interval"; exit 1; }

crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
(crontab -l 2>/dev/null; echo "$expr /usr/local/bin/mbm backup >/dev/null 2>&1 $CRON_TAG") | crontab -
echo "Cron set: $expr"
}

jalali_stamp(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d_%H-%M-%S"))
PY
}

jalali_human(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d %H:%M:%S"))
PY
}

proxy_try(){
local p="$1"
curl --proxy "$p" -I -s --max-time 10 https://api.telegram.org >/dev/null 2>&1
}

validate_proxy(){
while true; do
  echo
  echo "SOCKS5 Proxy (optional)"
  echo "Formats:"
  echo "  socks5h://127.0.0.1:1080   (recommended for Iran - DNS via proxy)"
  echo "  socks5://127.0.0.1:1080"
  echo "Tip: you can also enter just: 127.0.0.1:1080"
  echo "Leave empty if not needed:"
  read INPUT

  if [ -z "$INPUT" ]; then
    PROXY=""
    return
  fi

  if [[ "$INPUT" =~ ^http ]]; then
    echo "Invalid format âŒ Only socks5/socks5h supported"
    continue
  fi

  base=""
  if [[ "$INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
    base="$INPUT"
  elif [[ "$INPUT" =~ ^socks5h:// ]]; then
    base="${INPUT#socks5h://}"
  elif [[ "$INPUT" =~ ^socks5:// ]]; then
    base="${INPUT#socks5://}"
  else
    echo "Invalid format âŒ"
    continue
  fi

  c1="socks5h://$base"
  c2="socks5://$base"

  echo "Testing proxy (1/2): $c1"
  if proxy_try "$c1"; then
    echo "Proxy OK âœ… Using: $c1"
    PROXY="$c1"
    return
  fi

  echo "Testing proxy (2/2): $c2"
  if proxy_try "$c2"; then
    echo "Proxy OK âœ… Using: $c2"
    PROXY="$c2"
    return
  fi

  echo "Proxy failed âŒ (both socks5h and socks5) â€” try again."
done
}

cmd_install(){
install_deps

echo "Telegram Bot Token:"
read TOKEN

echo "Telegram Chat ID:"
read CHAT_ID

validate_proxy

echo
echo "Backup interval (minutes):"
read INTERVAL_MINUTES

save_conf
setup_cron
echo "Installed successfully âœ…"
}

cmd_backup(){
load_conf
DIR="/opt/marzban/backup"
mkdir -p "$DIR"

marzban backup >/dev/null 2>&1 || true

LATEST=$(ls -t "$DIR"/*.tar.gz 2>/dev/null | head -n1 || true)
[ -n "$LATEST" ] || { echo "No backup found in $DIR"; exit 1; }

STAMP=$(jalali_stamp)
HUMAN=$(jalali_human)
NEW="$DIR/backup_${STAMP}.tar.gz"
mv -f "$LATEST" "$NEW"

CAPTION="ðŸ“¦ Backup Information
ðŸŒ Server IP: $(hostname -I | awk '{print $1}')
ðŸ“ Backup File: $NEW
â° Backup Time: $HUMAN"

API="https://api.telegram.org/bot${TOKEN}/sendDocument"

if [ -n "${PROXY:-}" ]; then
curl --proxy "$PROXY" -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
else
curl -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
fi

echo "Backup sent âœ…"
}

cmd_restore(){
FILE="$2"
[ -f "$FILE" ] || { echo "File not found"; exit 1; }
marzban down >/dev/null 2>&1 || true
tar -xzf "$FILE" -C /
marzban up -n >/dev/null 2>&1 || true
echo "Restore complete âœ…"
}

cmd_uninstall(){
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
rm -rf "$APP_DIR"
rm -f /usr/local/bin/mbm
echo "Uninstalled âœ…"
}

case "$1" in
install) cmd_install ;;
backup) cmd_backup ;;
restore) cmd_restore "$@" ;;
uninstall) cmd_uninstall ;;
*) echo "Usage: mbm {install|backup|restore|uninstall}" ;;
esac
