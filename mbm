#!/usr/bin/env bash
set -e

APP_DIR="/opt/marzban-backup"
CONF="$APP_DIR/config.conf"
CRON_TAG="# mbm-backup"

install_deps(){
apt-get update -y >/dev/null 2>&1 || true
apt-get install -y curl python3 python3-pip cron >/dev/null 2>&1 || true
systemctl enable --now cron >/dev/null 2>&1 || true
python3 -m pip install -q jdatetime >/dev/null 2>&1 || true
}

save_conf(){
mkdir -p "$APP_DIR"
cat > "$CONF" <<CFG
TOKEN="$TOKEN"
CHAT_ID="$CHAT_ID"
PROXY="$PROXY"
INTERVAL_MINUTES="$INTERVAL_MINUTES"
CFG
chmod 600 "$CONF"
}

load_conf(){
source "$CONF"
}

setup_cron(){
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
(crontab -l 2>/dev/null; echo "*/$INTERVAL_MINUTES * * * * /usr/local/bin/mbm backup >/dev/null 2>&1 $CRON_TAG") | crontab -
}

jalali_stamp(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d_%H-%M-%S"))
PY
}

jalali_human(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d %H:%M:%S"))
PY
}

validate_proxy(){
while true; do
echo
echo "SOCKS5 Proxy (optional)"
echo "Format: socks5://127.0.0.1:1080"
echo "Leave empty if not needed:"
read INPUT

if [ -z "$INPUT" ]; then
PROXY=""
return
fi

# Ø§Ú¯Ø± ÙÙ‚Ø· ip:port Ø¯Ø§Ø¯
if [[ "$INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
INPUT="socks5://$INPUT"
fi

# Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² http
if [[ "$INPUT" =~ ^http ]]; then
echo "Invalid format âŒ Only socks5 supported"
continue
fi

# Ú†Ú© ÙØ±Ù…Øª Ù†Ù‡Ø§ÛŒÛŒ
if [[ ! "$INPUT" =~ ^socks5:// ]]; then
echo "Invalid format âŒ"
continue
fi

echo "Testing proxy connection..."
if curl --proxy "$INPUT" -m 10 -s https://api.telegram.org >/dev/null; then
echo "Proxy OK âœ…"
PROXY="$INPUT"
return
else
echo "Proxy failed âŒ Try again."
fi

done
}

cmd_install(){
install_deps

echo "Telegram Bot Token:"
read TOKEN

echo "Telegram Chat ID:"
read CHAT_ID

validate_proxy

echo
echo "Backup interval (minutes):"
read INTERVAL_MINUTES

save_conf
setup_cron
echo "Installed successfully âœ…"
}

cmd_backup(){
load_conf
DIR="/opt/marzban/backup"
mkdir -p "$DIR"
marzban backup >/dev/null 2>&1 || true
LATEST=$(ls -t "$DIR"/*.tar.gz 2>/dev/null | head -n1)
STAMP=$(jalali_stamp)
HUMAN=$(jalali_human)
NEW="$DIR/backup_${STAMP}.tar.gz"
mv -f "$LATEST" "$NEW"

CAPTION="ðŸ“¦ Backup Information
ðŸŒ Server IP: $(hostname -I | awk '{print $1}')
ðŸ“ Backup File: $NEW
â° Backup Time: $HUMAN"

API="https://api.telegram.org/bot${TOKEN}/sendDocument"

if [ -n "$PROXY" ]; then
curl --proxy "$PROXY" -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
else
curl -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
fi

echo "Backup sent âœ…"
}

cmd_restore(){
FILE="$2"
[ -f "$FILE" ] || { echo "File not found"; exit 1; }
marzban down >/dev/null 2>&1 || true
tar -xzf "$FILE" -C /
marzban up -n >/dev/null 2>&1 || true
echo "Restore complete âœ…"
}

cmd_uninstall(){
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
rm -rf "$APP_DIR"
rm -f /usr/local/bin/mbm
echo "Uninstalled âœ…"
}

case "$1" in
install) cmd_install ;;
backup) cmd_backup ;;
restore) cmd_restore "$@" ;;
uninstall) cmd_uninstall ;;
*) echo "Usage: mbm {install|backup|restore|uninstall}" ;;
esac
