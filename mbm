#!/usr/bin/env bash
set -e

# Colors
RED='\033[0;31m'; GRN='\033[0;32m'; YLW='\033[0;33m'; CYN='\033[0;36m'
MAG='\033[0;35m'; WHT='\033[1;37m'; NC='\033[0m'
say(){ echo -e "${CYN}âœ${NC} $*"; }
ok(){ echo -e "${GRN}âœ”${NC} $*"; }
warn(){ echo -e "${YLW}âš ${NC} $*"; }
err(){ echo -e "${RED}âœ–${NC} $*"; }

APP_DIR="/opt/marzban-backup"
CONF="$APP_DIR/config.conf"
CRON_TAG="# mbm-backup"

help(){
echo -e "${MAG}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${WHT}Marzban Backup Manager (mbm)${NC}"
echo -e "${MAG}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYN}Usage:${NC}"
echo -e "  ${WHT}mbm install${NC}     Setup Telegram + Proxy + Schedule (and run first backup)"
echo -e "  ${WHT}mbm backup${NC}      Create backup now and send to Telegram"
echo -e "  ${WHT}mbm restore <file>${NC}  Restore a backup tar.gz and restart marzban"
echo -e "  ${WHT}mbm uninstall${NC}   Remove mbm + cron + config"
echo -e "  ${WHT}mbm help${NC}        Show this help"
echo
echo -e "${YLW}Proxy formats (optional):${NC}"
echo -e "  socks5h://127.0.0.1:1080   (recommended for Iran)"
echo -e "  socks5://127.0.0.1:1080"
echo -e "  or just: 127.0.0.1:1080"
echo -e "${MAG}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

install_deps(){
say "Installing dependencies..."
export DEBIAN_FRONTEND=noninteractive

apt-get update -y >/dev/null 2>&1 || true
apt-get install -y curl cron python3 python3-pip >/dev/null 2>&1 || true
systemctl enable --now cron >/dev/null 2>&1 || true

# jdatetime: try apt first, then pip fallback
if python3 -c "import jdatetime" >/dev/null 2>&1; then
  ok "Python module jdatetime is available"
  return
fi

apt-get install -y python3-jdatetime >/dev/null 2>&1 || true

if python3 -c "import jdatetime" >/dev/null 2>&1; then
  ok "Installed jdatetime via apt"
  return
fi

# pip fallback (handles Debian/Ubuntu externally-managed)
python3 -m pip install -q --upgrade pip >/dev/null 2>&1 || true
python3 -m pip install -q jdatetime --break-system-packages >/dev/null 2>&1 || \
python3 -m pip install -q --user jdatetime >/dev/null 2>&1 || true

python3 -c "import jdatetime" >/dev/null 2>&1 && ok "Installed jdatetime via pip" || warn "Could not auto-install jdatetime"
}

ensure_deps(){
# Make backup reliable even if user never ran install (but still needs config)
if ! command -v curl >/dev/null 2>&1 || ! command -v python3 >/dev/null 2>&1; then
  install_deps
fi
python3 -c "import jdatetime" >/dev/null 2>&1 || install_deps
}

save_conf(){
mkdir -p "$APP_DIR"
cat > "$CONF" <<CFG
TOKEN="$TOKEN"
CHAT_ID="$CHAT_ID"
PROXY="$PROXY"
INTERVAL_MINUTES="$INTERVAL_MINUTES"
CFG
chmod 600 "$CONF"
}

load_conf(){
[ -f "$CONF" ] || { err "Not installed. Run: mbm install"; exit 1; }
# shellcheck disable=SC1090
source "$CONF"
}

cron_expr_from_minutes(){
M="$1"
if ! [[ "$M" =~ ^[0-9]+$ ]] || [ "$M" -lt 1 ]; then
  echo ""
  return
fi

if [ "$M" -lt 60 ]; then
  echo "*/$M * * * *"
  return
fi

H=$(( M / 60 ))
R=$(( M % 60 ))

if [ "$H" -ge 24 ] && [ "$R" -eq 0 ]; then
  echo "0 0 */$((H/24)) * *"
  return
fi

if [ "$H" -ge 24 ] && [ "$R" -ne 0 ]; then
  echo "*/$R 0 */$((H/24)) * *"
  return
fi

if [ "$R" -eq 0 ]; then
  echo "0 */$H * * *"
else
  echo "*/$R */$H * * *"
fi
}

setup_cron(){
expr="$(cron_expr_from_minutes "$INTERVAL_MINUTES")"
[ -n "$expr" ] || { err "Invalid interval. Enter a number of minutes (>=1)."; exit 1; }

crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
(crontab -l 2>/dev/null; echo "$expr /usr/local/bin/mbm backup >/dev/null 2>&1 $CRON_TAG") | crontab -
ok "Cron set: $expr"
}

jalali_stamp(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d_%H-%M-%S"))
PY
}

jalali_human(){
python3 - <<PY
from datetime import datetime
import jdatetime
print(jdatetime.datetime.fromgregorian(datetime=datetime.now()).strftime("%Y-%m-%d %H:%M:%S"))
PY
}

proxy_try(){
local p="$1"
curl --proxy "$p" -I -s --max-time 10 https://api.telegram.org >/dev/null 2>&1
}

validate_proxy(){
while true; do
  echo
  echo -e "${WHT}SOCKS5 Proxy (optional)${NC}"
  echo "Formats:"
  echo "  socks5h://127.0.0.1:1080   (recommended for Iran - DNS via proxy)"
  echo "  socks5://127.0.0.1:1080"
  echo "Tip: you can also enter just: 127.0.0.1:1080"
  echo "Leave empty if not needed:"
  read INPUT

  if [ -z "$INPUT" ]; then
    PROXY=""
    return
  fi

  if [[ "$INPUT" =~ ^http ]]; then
    err "Invalid format. Only socks5/socks5h supported."
    continue
  fi

  base=""
  if [[ "$INPUT" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+:[0-9]+$ ]]; then
    base="$INPUT"
  elif [[ "$INPUT" =~ ^socks5h:// ]]; then
    base="${INPUT#socks5h://}"
  elif [[ "$INPUT" =~ ^socks5:// ]]; then
    base="${INPUT#socks5://}"
  else
    err "Invalid format."
    continue
  fi

  c1="socks5h://$base"
  c2="socks5://$base"

  say "Testing proxy (1/2): $c1"
  if proxy_try "$c1"; then
    ok "Proxy OK. Using: $c1"
    PROXY="$c1"
    return
  fi

  say "Testing proxy (2/2): $c2"
  if proxy_try "$c2"; then
    ok "Proxy OK. Using: $c2"
    PROXY="$c2"
    return
  fi

  err "Proxy failed with both socks5h and socks5. Try again."
done
}

cmd_install(){
ensure_deps

echo -e "${CYN}Telegram Bot Token:${NC}"
read TOKEN

echo -e "${CYN}Telegram Chat ID:${NC}"
read CHAT_ID

validate_proxy

echo -e "${CYN}\nBackup interval (minutes):${NC}"
read INTERVAL_MINUTES

save_conf
setup_cron
ok "Installed successfully âœ…"

# Immediate first backup after install
say "Running first backup now..."
cmd_backup
}

cmd_backup(){
ensure_deps
load_conf

DIR="/opt/marzban/backup"
mkdir -p "$DIR"

if ! command -v marzban >/dev/null 2>&1; then
  err "marzban command not found on this server."
  exit 1
fi

marzban backup >/dev/null 2>&1 || true

LATEST=$(ls -t "$DIR"/*.tar.gz 2>/dev/null | head -n1 || true)
[ -n "$LATEST" ] || { err "No backup file found in $DIR"; exit 1; }

STAMP=$(jalali_stamp)
HUMAN=$(jalali_human)
NEW="$DIR/backup_${STAMP}.tar.gz"
mv -f "$LATEST" "$NEW"

CAPTION="ğŸ“¦ Backup Information
ğŸŒ Server IP: $(hostname -I | awk '{print $1}')
ğŸ“ Backup File: $NEW
â° Backup Time: $HUMAN"

API="https://api.telegram.org/bot${TOKEN}/sendDocument"

if [ -n "${PROXY:-}" ]; then
  curl --proxy "$PROXY" -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
else
  curl -F chat_id="$CHAT_ID" -F caption="$CAPTION" -F document=@"$NEW" "$API" >/dev/null
fi

ok "Backup sent âœ…"
}

cmd_restore(){
ensure_deps
FILE="$2"
[ -f "$FILE" ] || { err "File not found: $FILE"; exit 1; }

if ! command -v marzban >/dev/null 2>&1; then
  err "marzban command not found on this server."
  exit 1
fi

say "Stopping marzban..."
marzban down >/dev/null 2>&1 || true

say "Extracting backup..."
tar -xzf "$FILE" -C /

say "Starting marzban..."
marzban up -n >/dev/null 2>&1 || true

ok "Restore complete âœ…"
}

cmd_uninstall(){
crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
rm -rf "$APP_DIR"
rm -f /usr/local/bin/mbm
ok "Uninstalled âœ…"
}

case "${1:-}" in
install) cmd_install ;;
backup) cmd_backup ;;
restore) cmd_restore "$@" ;;
uninstall) cmd_uninstall ;;
help|"") help ;;
*) help ;;
esac
