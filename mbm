#!/usr/bin/env bash
set -euo pipefail

APP_DIR="/opt/marzban-backup"
CONF="$APP_DIR/config.conf"
BIN="/usr/local/bin/mbm"
CRON_TAG="# mbm-backup"

# ===== colors =====
RED='\033[0;31m'; GRN='\033[0;32m'; YLW='\033[0;33m'; CYN='\033[0;36m'
MAG='\033[0;35m'; WHT='\033[1;37m'; NC='\033[0m'
say(){ echo -e "${CYN}âžœ${NC} $*"; }
ok(){ echo -e "${GRN}âœ”${NC} $*"; }
warn(){ echo -e "${YLW}âš ${NC} $*"; }
err(){ echo -e "${RED}âœ–${NC} $*"; }
title(){ echo -e "${MAG}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}\n${WHT}$*${NC}\n${MAG}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"; }

need_root(){ [ "$(id -u)" -eq 0 ] || { err "Run as root"; exit 1; }; }

install_deps(){
  title "Installing dependencies"
  if command -v apt-get >/dev/null 2>&1; then
    say "apt-get: curl python3 python3-pip"
    apt-get update -y
    apt-get install -y curl python3 python3-pip
  elif command -v yum >/dev/null 2>&1; then
    say "yum: curl python3 python3-pip"
    yum install -y curl python3 python3-pip || yum install -y curl python3 || true
  else
    err "No supported package manager. Install curl+python3+pip manually."
    exit 1
  fi

  say "Installing python module: jdatetime"
  python3 -m pip install -q --upgrade pip >/dev/null 2>&1 || true
  python3 -m pip install -q jdatetime >/dev/null 2>&1
  ok "Deps OK"
}

load_conf(){
  [ -f "$CONF" ] || { err "Not installed. Run: mbm install"; exit 1; }
  # shellcheck disable=SC1090
  source "$CONF"
}

save_conf(){
  mkdir -p "$APP_DIR"
  {
    printf 'TOKEN="%s"\n' "$TOKEN"
    printf 'CHAT_ID="%s"\n' "$CHAT_ID"
    printf 'PROXY="%s"\n' "$PROXY"
    printf 'INTERVAL_MINUTES="%s"\n' "$INTERVAL_MINUTES"
  } > "$CONF"
  chmod 600 "$CONF"
}

setup_cron(){
  crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
  (crontab -l 2>/dev/null; echo "*/$INTERVAL_MINUTES * * * * $BIN backup >/dev/null 2>&1 $CRON_TAG") | crontab -
  ok "Cron: every $INTERVAL_MINUTES minute(s)"
}

remove_cron(){
  crontab -l 2>/dev/null | grep -v "$CRON_TAG" | crontab - 2>/dev/null || true
}

detect_ip(){
  local ip=""
  ip=$(ip -4 route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if($i=="src"){print $(i+1); exit}}' || true)
  [ -z "$ip" ] && ip=$(ip -4 -br a 2>/dev/null | awk '$1!="lo"{print $3}' | head -n1 | cut -d/ -f1 || true)
  [ -z "$ip" ] && ip=$(curl -s --max-time 5 ifconfig.me || true)
  echo "${ip:-unknown}"
}

tz_offset(){ date +%z 2>/dev/null || echo ""; }

jalali_stamp(){
  python3 - <<'PY'
from datetime import datetime
import jdatetime
jnow = jdatetime.datetime.fromgregorian(datetime=datetime.now())
print(jnow.strftime("%Y-%m-%d_%H-%M-%S"))
PY
}

jalali_human(){
  python3 - <<'PY'
from datetime import datetime
import jdatetime
jnow = jdatetime.datetime.fromgregorian(datetime=datetime.now())
print(jnow.strftime("%Y-%m-%d %H:%M:%S"))
PY
}

cmd_install(){
  need_root
  install_deps

  title "mbm install"
  read -r -p "Telegram Bot Token: " TOKEN
  read -r -p "Telegram Chat ID (numeric): " CHAT_ID
  read -r -p "SOCKS Proxy (optional, ex: socks5h://127.0.0.1:1080): " PROXY
  read -r -p "Backup interval (minutes, ex: 60): " INTERVAL_MINUTES

  [ -n "$TOKEN" ] || { err "TOKEN empty"; exit 1; }
  [ -n "$CHAT_ID" ] || { err "CHAT_ID empty"; exit 1; }
  [[ "$INTERVAL_MINUTES" =~ ^[0-9]+$ ]] && [ "$INTERVAL_MINUTES" -gt 0 ] || { err "Interval invalid"; exit 1; }

  save_conf
  setup_cron
  ok "Installed âœ…"
  say "Try: mbm backup"
}

cmd_backup(){
  load_conf
  title "mbm backup"

  local server_ip backup_dir latest stamp human tz newfile caption api
  local -a proxy_args=()

  server_ip="$(detect_ip)"
  backup_dir="/opt/marzban/backup"
  mkdir -p "$backup_dir"

  say "Running: marzban backup"
  if ! marzban backup >/dev/null 2>&1; then
    warn "marzban backup failed; trying latest existing backup..."
  fi

  latest="$(ls -t "$backup_dir"/*.tar.gz 2>/dev/null | head -n1 || true)"
  [ -n "$latest" ] || { err "No backup .tar.gz found in $backup_dir"; exit 1; }

  stamp="$(jalali_stamp)"
  human="$(jalali_human)"
  tz="$(tz_offset)"
  newfile="$backup_dir/backup_${stamp}.tar.gz"

  if [ "$latest" != "$newfile" ]; then
    mv -f "$latest" "$newfile"
    ok "Renamed -> $(basename "$newfile")"
  else
    ok "Filename already OK"
  fi

  caption="ðŸ“¦ Backup Information
ðŸŒ Server IP: $server_ip
ðŸ“ Backup File: $newfile
â° Backup Time: ${human} ${tz}"

  api="https://api.telegram.org/bot${TOKEN}/sendDocument"

  if [ -n "${PROXY:-}" ]; then
    proxy_args=(--proxy "$PROXY")
    say "Proxy: $PROXY"
  else
    say "Proxy: (none)"
  fi

  say "Sending to Telegram..."
  curl -sS "${proxy_args[@]}" \
    -F chat_id="$CHAT_ID" \
    -F caption="$caption" \
    -F document=@"$newfile" \
    "$api" >/dev/null

  ok "Backup sent âœ…"
  echo "$newfile"
}

cmd_restore(){
  need_root
  title "mbm restore"

  local file="${2:-}"
  [ -n "$file" ] || { err "Usage: mbm restore /path/to/backup.tar.gz"; exit 1; }
  [ -f "$file" ] || { err "File not found: $file"; exit 1; }

  warn "Ø§ÛŒÙ† Ú©Ø§Ø± Ø¯ÛŒØªØ§ Ø±Ùˆ Ø¨Ø§ Ø¨Ú©Ø§Ù¾ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ù‡."
  read -r -p "Continue? (y/N): " ans
  [[ "$ans" =~ ^[Yy]$ ]] || { warn "Canceled."; exit 0; }

  say "Stopping Marzban..."
  marzban down >/dev/null 2>&1 || true
  ok "Stopped"

  say "Extracting to / ..."
  tar -xzf "$file" -C /
  ok "Extracted"

  say "Starting Marzban..."
  marzban up -n >/dev/null 2>&1 || true
  ok "Restore completed âœ…"
}

cmd_uninstall(){
  need_root
  title "mbm uninstall"

  remove_cron
  rm -rf "$APP_DIR"
  rm -f "$BIN"

  ok "Uninstalled completely âœ…"
}

cmd_help(){
  title "Marzban Backup Manager (mbm) â€” Help"
  cat <<'H'
Commands:
  mbm install
  mbm backup
  mbm restore /path/to/backup.tar.gz
  mbm uninstall
  mbm help

Notes:
- Backup filename (Jalali): backup_1404-11-24_16-00-01.tar.gz
- Caption includes Server IP, file path, and Jalali time.
- SOCKS proxy is optional (use in Iran).
H
}

case "${1:-help}" in
  install)   cmd_install ;;
  backup)    cmd_backup ;;
  restore)   cmd_restore "$@" ;;
  uninstall) cmd_uninstall ;;
  help|-h|--help) cmd_help ;;
  *) err "Unknown command: ${1:-}"; cmd_help; exit 1 ;;
esac
